/*
This Script is Copyright by Tub (spam@authmann.de).

see index.html for full copyright information.
*/

function getFormElement(a){var c,b=document.getElementById("mainform");if(!b){window.status="mainform not found";return false}c=b.elements[a];if(!c){window.status="form element "+a+" not found";return false}return c}function get(a){var b=getFormElement(a);if(b.type=="checkbox"&&b.checked==false){return 0}return parseInt(b.value)}function uncheck(a){check(a,false)}function check(b,a){var c;if(a==null){a=true}c=getFormElement(b);if(c&&c.type=="checkbox"){c.checked=a}}function parse(c,b,a){var d,e=getFormElement(c);d=parseInt(e.value);if(b!=null&&d<b){d=b}if(a!=null&&d>a){d=a}e.value=d;return d}function getElement(a){var b=document.getElementById(a);if(!b){window.status="element "+a+" not found";return false}return b}function show(a){var b=getElement(a);b.style.display=""}function hide(a){var b=getElement(a);b.style.display="none"}function set(b,e,d){var a,c=getElement(b);while(c.hasChildNodes()){c.removeChild(c.firstChild)}a=document.createTextNode(e);c.appendChild(a);if(d==true){c.style.backgroundColor="#ff0000";c.style.border="1px solid #000000";c.style.padding="1px 2px"}else{if(d==false){c.style.backgroundColor="";c.style.border="";c.style.padding=""}}}function clearChildNodes(a){while(a.hasChildNodes()){a.removeChild(a.firstChild)}}var classnames=new Array("","amazon","assassin","barbarian","druid","necromancer","paladin","sorceress");var classnames_readable=new Array("","Амазонка","Ассассин","Варвар","Друид","Некромант","Паладин","Колдунья");var skillnames;var func_constraints;var SKILLICONS_VERSION="005";var CURRENT_PATCH="2012005";var CURRENT_PATCH_READABLE;var IS_1E9_OR_NEWER=true;var IS_OMEGA=true;var cname="";var slvl=new Array();var max=new Array();var classnr;var clvl;var slvlmax;var slvlskillbonus;var slvlitembonus;var ennead;var blackroad;var energy;function changeVersion(){var a=getFormElement("version");CURRENT_PATCH=a.value;CURRENT_PATCH_READABLE=a.options[a.selectedIndex].text;IS_1E9_OR_NEWER=(CURRENT_PATCH!="199d"&&CURRENT_PATCH!="1A9"&&CURRENT_PATCH!="1D9");IS_OMEGA=(CURRENT_PATCH.substr(0,1)=="O")||(CURRENT_PATCH.substr(0,4)=="2012");switch(CURRENT_PATCH){case"199d":show("ac500_row");hide("minigamerow");hide("signetofskillrow");hide("enneadplusone");set("toraja_bonus","5");getFormElement("q7").value=5;skillnames=skillnames_199d;func_constraints=check_constraints_199d;break;case"1A9":hide("ac500_row");uncheck("ac500");hide("minigamerow");hide("signetofskillrow");hide("enneadplusone");set("toraja_bonus","1");getFormElement("q7").value=1;skillnames=skillnames_1A9;func_constraints=check_constraints_1A9;break;case"1D9":hide("ac500_row");uncheck("ac500");hide("minigamerow");hide("signetofskillrow");hide("enneadplusone");set("toraja_bonus","1");getFormElement("q7").value=1;skillnames=skillnames_1D9;func_constraints=check_constraints_1D9;break;case"1E9":hide("ac500_row");uncheck("ac500");show("windowsinhell");show("minigamerow");show("signetofskillrow");hide("enneadplusone");set("toraja_bonus","1");getFormElement("q7").value=1;skillnames=skillnames_1E9;func_constraints=check_constraints_1E9;break;case"1F9":hide("ac500_row");uncheck("ac500");show("windowsinhell");show("minigamerow");show("signetofskillrow");show("enneadplusone");set("toraja_bonus","1");getFormElement("q7").value=1;skillnames=skillnames_1F9;func_constraints=check_constraints_1F9;break;case"1G9":hide("ac500_row");uncheck("ac500");show("windowsinhell");show("minigamerow");show("signetofskillrow");show("enneadplusone");set("toraja_bonus","1");getFormElement("q7").value=1;skillnames=skillnames_1G9;func_constraints=check_constraints_1G9;break;case"1Z9":hide("ac500_row");uncheck("ac500");show("windowsinhell");show("minigamerow");show("signetofskillrow");show("enneadplusone");set("toraja_bonus","1");getFormElement("q7").value=1;skillnames=skillnames_1Z9;func_constraints=check_constraints_1Z9;break;case"O001":hide("ac500_row");uncheck("ac500");hide("windowsinhell");show("minigamerow");show("signetofskillrow");show("enneadplusone");set("toraja_bonus","1");getFormElement("q7").value=1;skillnames=skillnames_O001;func_constraints=check_constraints_O001;break;case"O002":hide("ac500_row");uncheck("ac500");hide("windowsinhell");show("minigamerow");show("signetofskillrow");show("enneadplusone");set("toraja_bonus","1");getFormElement("q7").value=1;skillnames=skillnames_O001;func_constraints=check_constraints_O002;break;case"O003":hide("ac500_row");uncheck("ac500");hide("windowsinhell");show("minigamerow");show("signetofskillrow");show("enneadplusone");set("toraja_bonus","1");getFormElement("q7").value=1;skillnames=skillnames_O003;func_constraints=check_constraints_O002;break;case"2012":hide("ac500_row");uncheck("ac500");hide("windowsinhell");show("minigamerow");show("signetofskillrow");show("enneadplusone");set("toraja_bonus","1");getFormElement("q7").value=1;skillnames=skillnames_2012;func_constraints=check_constraints_O002;break;case"2012004":hide("ac500_row");uncheck("ac500");hide("windowsinhell");show("minigamerow");show("signetofskillrow");show("enneadplusone");set("toraja_bonus","1");getFormElement("q7").value=1;skillnames=skillnames_2012004;func_constraints=check_constraints_O002;break;case"2012005":hide("ac500_row");uncheck("ac500");hide("windowsinhell");show("minigamerow");show("signetofskillrow");show("enneadplusone");set("toraja_bonus","1");getFormElement("q7").value=1;skillnames=skillnames_2012005;func_constraints=check_constraints_O002;break}changeClass()}function hasSlvlByItem(){if(classnr==7){return true}if(classnr==1&&IS_1E9_OR_NEWER&&CURRENT_PATCH!="1E9"&&!IS_OMEGA){return true}return false}function changeClass(){var d,c,b,a,g,e;classnr=get("class");if(classnr==1&&(CURRENT_PATCH=="199d"||CURRENT_PATCH=="1A9")){show("energy_row")}else{hide("energy_row")}if(classnr==1){show("hornedhunter");hide("venefica")}else{if(classnr==7){hide("hornedhunter");show("venefica")}}if(hasSlvlByItem()){show("slvl_by_item_row")}else{hide("slvl_by_item_row")}for(d=1;d<=30;d++){set("skill"+d+"_name",skillnames[classnr][d]);var f=document.getElementById("skill"+d+"_img");if(f){e=skillnames[classnr][d].replace(/ /g,"").replace(/[0-9]$/,"");b=-1;for(c=0;c<skillicons[classnr].length;c++){if(skillicons[classnr][c]==e){b=c;break}}if(b<0){f.style.backgroundImage="url(skillicons/red.gif)";f.style.backgroundPosition="0px 0px";continue}a=(b%10)*-50;g=Math.floor(b/10)*-50;f.style.backgroundImage="url(skillicons/"+classnames[classnr]+"_all.gif)";f.style.backgroundPosition=a+"px "+g+"px"}}recalculate()}function recalculate(){classnr=get("class");clvl=parse("clvl",1,120);if(clvl<40){for(var f=1;f<=3;f++){uncheck("q"+f+"_2")}uncheck("m3");for(var f=0;f<3;f++){uncheck("sos"+f)}}if(clvl<20){for(var f=1;f<=3;f++){uncheck("q"+f+"_1")}for(var f=0;f<3;f++){uncheck("m"+f)}}if(clvl<100){for(var f=4;f<=9;f++){uncheck("q"+f)}}if(clvl<120){uncheck("q7")}if(clvl<90){uncheck("ennead");uncheck("blackroad")}if(clvl<100){uncheck("ac500")}var e=(clvl-1);for(var f=1;f<=3;f++){for(var h=0;h<3;h++){e+=get("q"+f+"_"+h)}}if(IS_1E9_OR_NEWER){for(var f=0;f<3;f++){e+=get("sos"+f)}}set("pavail",e);energy=0;if(classnr==1&&(CURRENT_PATCH=="199d"||CURRENT_PATCH=="1A9")){energy=parse("energy",15,1125)}slvlmax=Math.floor(clvl/6)+2;slvlitembonus=0;for(var f=4;f<=8;f++){slvlitembonus+=get("q"+f)}if(hasSlvlByItem()){slvlitembonus+=get("q9")}if(CURRENT_PATCH=="199d"){slvlitembonus+=get("ac500")}if(IS_1E9_OR_NEWER){for(var f=0;f<4;f++){if(f!=2||!IS_OMEGA){slvlitembonus+=get("m"+f)}}}slvlskillbonus=0;ennead=get("ennead");blackroad=get("blackroad");if(IS_OMEGA&&ennead){slvlitembonus++}for(var a=1;a<=30;a++){slvl[a]=get("skill"+a+"_points");if(slvl[a]<0){slvl[a]=0}}var c=false;while(!c){c=checkConstraints()}set("slvlbonus",slvlskillbonus+slvlitembonus);for(var a=1;a<=30;a++){set("skill"+a+"_max",max[a]);var b=true;var j;j=getFormElement("skill"+a+"_points");j.disabled=(max[a]==0);if(slvl[a]>0&&max[a]==slvl[a]){j.style.backgroundColor="#C97F7F"}else{j.style.backgroundColor=""}j=getFormElement("skill"+a+"_plus");j.style.visibility=(slvl[a]<max[a])?"visible":"hidden";j=getFormElement("skill"+a+"_minus");j.style.visibility=(slvl[a]>0)?"visible":"hidden"}var g=0;for(var a=1;a<=30;a++){set("skill"+a+"_max",max[a]>0?("max: "+max[a]):"");var j=getFormElement("skill"+a+"_points");j.value=slvl[a];g+=slvl[a]}set("pspent",g,g>e)}function raiseMax(b,a){if(max[b]>0){max[b]+=a}}function lockout(c,b){if(b==null){b=c}for(var a=c;a<=b;a++){max[a]=0}}function checkConstraints(){slvlskillbonus=0;for(var a=1;a<=30;a++){var d=(a-1)%5;if(a>25){d=15}max[a]=slvlmax+slvlitembonus-d;if(max[a]<0){max[a]=0}if(slvl[a]<0){slvl[a]=0}if(clvl<d*6){slvl[a]=max[a]=0}}if(slvl[26]>0){max[27]=max[28]=0}if(slvl[27]>0){max[26]=max[28]=0}if(slvl[28]>0){max[26]=max[27]=0}if(!ennead){lockout(29)}if(!blackroad){lockout(30)}func_constraints();for(var a=0;a<5;a++){var d=a*5+1;for(var b=d;b<d+4;b++){if(max[b]==0||slvl[b]==0){max[b+1]=0}}}for(var a=1;a<=30;a++){raiseMax(a,slvlskillbonus)}var c=true;for(var a=1;a<=30;a++){if(slvl[a]>max[a]){c=false;slvl[a]=max[a]}}return c}function checkAll(c){for(var b=1;b<=3;b++){for(var e=0;e<3;e++){check("q"+b+"_"+e,c)}}var a=8;if(hasSlvlByItem()){a=9}for(var b=4;b<=a;b++){check("q"+b,c)}check("ennead",c);check("blackroad",c);check("ac500",c&&(CURRENT_PATCH=="199d"));for(var b=0;b<4;b++){check("m"+b,c&&IS_1E9_OR_NEWER)}for(var b=0;b<3;b++){check("sos"+b,c&&IS_1E9_OR_NEWER)}recalculate()}function changeSkill(c,b){var f=getFormElement("skill"+c+"_points");var e=parseInt(f.value);var d=0;var a=e+b;if(a<0){a=0}do{f.value=a;recalculate();d=parseInt(f.value)}while(d<a&&d<max[c])}function clickRaise(b,a){if(b.shiftKey){changeSkill(a,50)}else{changeSkill(a,1)}}function clickLower(b,a){if(b.shiftKey){changeSkill(a,-100)}else{changeSkill(a,-1)}}function resetSkills(){for(var a=1;a<=30;a++){var b=getFormElement("skill"+a+"_points");b.value="0"}recalculate()}function changeName(){var a="Планировщик навыков для Median XL";var b=getFormElement("cname");cname=b.value;if(cname==""){document.title=a}else{document.title=cname+" ("+classnames_readable[classnr]+") - "+a}}function do_load(){var e=document.mainform.offline_link.value;if(!e){return}var b=e.match(/class=[1-7]/)[0];if(!b){return}classnr=parseInt(b.slice(6));var o=getFormElement("class");o.options.selectedIndex=classnr-1;classnr=parseInt(b.slice(6));var o=getFormElement("class");o.options.selectedIndex=classnr-1;var p=e.match(/lvl=[0-9]+/);clvl=120;if(p){clvl=parseInt(p[0].slice(4))}getFormElement("clvl").value=clvl;var c=e.match(/v=[\dA-FOd]+/);if(!c){c="199d"}else{c=c[0].slice(2)}CURRENT_PATCH=c;IS_1E9_OR_NEWER=(CURRENT_PATCH!="199d"&&CURRENT_PATCH!="1A9"&&CURRENT_PATCH!="1D9");IS_OMEGA=(CURRENT_PATCH.substr(0,1)=="O")||(CURRENT_PATCH.substr(0,4)=="2012");var f=getFormElement("version");for(var s=0;s<f.options.length;s++){if(f.options[s].value==CURRENT_PATCH){f.options.selectedIndex=s;break}}var u=e.match(/bonus=[01]+/)[0];if(!u||u.length<23){return}if(CURRENT_PATCH=="199d"){check("ac500",u.charAt(17)=="1");u=u.substr(0,17)+u.substr(18)}for(var j=1;j<=3;j++){for(var t=0;t<3;t++){check("q"+j+"_"+t,(u.charAt(3+3*j+t)=="1"))}}check("ennead",(u.charAt(15)=="1"));check("blackroad",(u.charAt(16)=="1"));for(var j=4;j<=9;j++){check("q"+j,(u.charAt(j+13)=="1"))}energy=15;if(classnr==1&&(CURRENT_PATCH=="199d"||CURRENT_PATCH=="1A9")){var l=e.match(/energy=[0-9]+/)[0];if(l){energy=parseInt(l.slice(7))}}var g=getFormElement("energy");g.value=energy;var a=e.match(/skills=[0-9_]+/)[0];if(!a||a.length<67){return}var n=a.slice(7).split("_");for(var s=1;s<=30;s++){slvl[s]=parseInt(n[s-1]);var g=getFormElement("skill"+s+"_points");g.value=slvl[s]}if(IS_1E9_OR_NEWER){var h=e.match(/mg=[01]+/)[0];if(!h||h.length<7){return}for(var j=0;j<4;j++){check("m"+j,(h.charAt(j+3)=="1"))}var k=e.match(/sos=[0123]/)[0];if(!k||k.length!=5){return}var m=parseInt(k.charAt(4));for(var j=0;j<m;j++){check("sos"+j,true)}for(var j=m;j<3;j++){check("sos"+j,false)}}var r=e.match(/name=.*/)[0];if(!r){return}cname=decodeURI(r.slice(5));var g=getFormElement("cname");g.value=cname;changeName()}function load(){do_load();changeVersion()}function save(){var b="v="+CURRENT_PATCH;b+="&class="+classnr+"&lvl="+clvl+"&bonus=";for(var a=1;a<=3;a++){for(var h=0;h<3;h++){b+=get("q"+a+"_"+h)>0?"1":"0"}}b+=get("ennead")>0?"1":"0";b+=get("blackroad")>0?"1":"0";if(CURRENT_PATCH=="199d"){b+=get("ac500")>0?"1":"0"}for(var a=4;a<=9;a++){b+=get("q"+a)>0?"1":"0"}if(classnr==1&&(CURRENT_PATCH=="199d"||CURRENT_PATCH=="1A9")){b+="&energy="+energy}b+="&skills=";for(var e=1;e<=30;e++){b+=slvl[e]+"_"}if(IS_1E9_OR_NEWER){b+="&mg=";for(var a=0;a<4;a++){b+=get("m"+a)>0?"1":"0"}var c=0;for(var a=0;a<3;a++){c+=get("sos"+a)}b+="&sos="+c}b+="&name="+encodeURIComponent(cname);var k="http://www.authmann.de/d2/mxl/skillpointplanner/";var j=k+"?"+b;document.mainform.offline_link.value=j;document.mainform.btnShow.disabled=false;var f="План навыков "+cname+" ("+classnames_readable[classnr]+", "+CURRENT_PATCH_READABLE+")";set("save_url",f);document.getElementById("save_url").href=j;var g=document.getElementById("save_bbcode");g.value="[url="+j+"]"+f+"[/url]";hideSave(false);g.focus();g.select()}function hideSave(a){if(a==false){show("blackout");show("overlay_save");show("overlay")}else{hide("blackout");hide("overlay_save");hide("overlay");document.mainform.offline_link.focus();document.mainform.offline_link.select()}}function showFaq(a){if(a==false){hide("blackout");hide("overlay_faq");hide("overlay")}else{show("blackout");show("overlay_faq");show("overlay")}};